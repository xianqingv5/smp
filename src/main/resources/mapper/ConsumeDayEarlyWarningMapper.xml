<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yiche.smp.mapper.ConsumeDayEarlyWarningMapper">
    <select id="selectEarlyWarning" parameterType="map" resultType="com.yiche.smp.common.EarlyWarningData">
        SELECT
            a.platformName,
            a.actualConsume,
            a.leadsCnt,
            a.bt,
            b.month_day_avgclue_cnt monthDayAvgclueCnt,
            b.base_number baseNumber,
            b.day_budget dayBudget
        FROM
            (
                SELECT
                    "易车APP" platformName,
                    SUM(actual_consume) actualConsume,
                    SUM(leads_cnt) leadsCnt,
                    bt bt
                FROM
                    yiche_app_app_leads_channel_day_all
                WHERE
                    bt BETWEEN #{startTime}
                    AND #{endTime}
                    AND channel_id IN (
                        SELECT
                            channel_id
                        FROM
                            imp_platform_channel
                        WHERE
                            platform_name = "易车APP"
                    )
                GROUP BY
                    bt
                UNION
                SELECT
                    "报价APP" platformName,
                    SUM(actual_consume) actualConsume,
                    SUM(leads_cnt) leadsCnt,
                    bt bt
                FROM
                    yiche_quote_app_leads_channel_day_all
                WHERE
                    bt BETWEEN #{startTime}
                    AND #{endTime}
                    AND channel_id IN (
                        SELECT
                            channel_id
                        FROM
                            imp_platform_channel
                        WHERE
                            platform_name = "报价APP"
                    )
                GROUP BY
                    bt
                UNION
                SELECT
                    "PCWAP" platformName,
                    SUM(actual_consume) actualConsume,
                    SUM(cluecount) leadsCnt,
                    dt bt
                FROM
                    yiche_pcwap_app_leads_channel_day_all
                WHERE
                    dt BETWEEN #{startTime}
                    AND #{endTime}
                    AND channel_id IN (
                        SELECT
                            channel_id
                        FROM
                            imp_platform_channel
                        WHERE
                            platform_name = "PCWAP"
                    )
                GROUP BY
                    dt
            ) a,
            yiche_month_data_standard b
        WHERE
            a.platformName = b.platform_name
            AND a.platformName = #{platformName}
            AND b.month = #{month}
    </select>

    <select id="selectMonthChannelConsumeData" parameterType="map" resultType="com.yiche.smp.common.EarlyWarningData">
        SELECT
            c.platformName platformName,
            c.actualConsume actualConsume,
            c.leadsCnt leadsCnt,
            d.month_day_avgclue_cnt monthDayAvgclueCnt,
            d.base_number baseNumber,
            d.day_budget dayBudget
        FROM
            (
                SELECT
                    "易车APP" platformName,
                    SUM(actual_consume) actualConsume,
                    SUM(leads_cnt) leadsCnt
                FROM
                    yiche_app_app_leads_channel_day_all a,
                    imp_platform_channel b
                WHERE
                    a.channel_id = b.channel_id
                    AND bt BETWEEN #{startTime}
                    AND #{endTime}
                    AND platform_id = '1'
                GROUP BY
                    platform_id
                UNION
                SELECT
                    "报价APP" platformName,
                    SUM(actual_consume) actualConsume,
                    SUM(leads_cnt) leadsCnt
                FROM
                    yiche_quote_app_leads_channel_day_all a,
                    imp_platform_channel b
                WHERE
                    a.channel_id = b.channel_id
                    AND a.bt BETWEEN #{startTime}
                    AND #{endTime}
                    AND platform_id = '2'
                GROUP BY
                    platform_id
                UNION
                SELECT
                    "PCWAP" platformName,
                    SUM(actual_consume) actualConsume,
                    SUM(cluecount) leadsCnt
                FROM
                    yiche_pcwap_app_leads_channel_day_all a,
                    imp_platform_channel b
                WHERE
                    a.channel_id = b.channel_id
                    AND a.dt BETWEEN #{startTime}
                    AND #{endTime}
                    AND platform_id = '3'
                GROUP BY
                    platform_id
            ) c,
            yiche_month_data_standard d
        WHERE
            c.platformName = d.platform_name
            AND c.platformName = #{platformName}
            AND d.month = #{month}
    </select>

</mapper>